extends ./template.pug

block content
	.row
		.col-md-12
			.card
				.card-header
					h4.card-title Water Bills
				.card-body
					table#waterTable.table.table-bordered.table-striped(cellspacing='0')
						thead
							tr
								th Bill Date
								th Amount Due
								th Cubic Meter Used
								th Actions
						tbody
							each bill in water
								tr
									td #{bill.billDate}
									td #{bill.dblTotalAmountDue}
									td #{bill.intTotalCubicMeterUsage}
									td 
										button.encodeWaterOpen.btn.btn-primary.btn-round(billId=`${bill.intId}` totalCubic=`${bill.intTotalCubicMeterUsage}` amountDue=`${bill.dblTotalAmountDue}` dueDate=`${bill.intDueYear}-${bill.intDueMonth}-${bill.intDueDay}`) Encode Consumption
	//MODALS
	#encodeWaterModal.modal.fade(tabindex='-1', role='dialog', aria-hidden='true')
		.modal-dialog.modal-lg(role='document')
			.modal-content
				.modal-header
					h5.modal-title Add Water Bill
					button.close(type='button', data-dismiss='modal', aria-label='Close')
						span(aria-hidden='true') Ã—
				form#encodeWaterForm
					.modal-body#encodeWaterModalBody
					.modal-footer
						button#encodeWaterSave.btn.btn-primary(type='submit') Save
block contentScript
	script.
		$(document).ready(function(){
			$('#waterTable').dataTable();
			$('.encodeWaterOpen').on('click', function(){
				$.post('/admin/get-readings', {billId: $(this).attr('billId'), type:'water'})
				.done(function (data){
					for(let i = 0; i< data.length; i++){
						$('#encodeWaterModalBody').append(`
							<h6>Stall ${data[i].strStallId}</h6>
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label>Last Month Reading<small class="text-danger"> *</small></label>
										<input class="form-control" type="text" disabled="disabled" value="${data[i].intMeterReading}" />
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label>Current Month Reading<small class="text-danger"> *</small></label>
										<input class="form-control input-cubic" contractId="${data[i].intId}" previousReading="${data[i].intMeterReading}" type="text" placeholder="Enter Current Meter Reading" />
									</div>
								</div>
							</div><br/>`
						)
					}
				})
				$('#encodeWaterSave').attr('usage', $(this).attr('totalCubic'))
				$('#encodeWaterSave').attr('amountDue', $(this).attr('amountDue'))
				$('#encodeWaterSave').attr('dueDate', $(this).attr('dueDate'))
				$('#encodeWaterSave').attr('billId', $(this).attr('billId'))
				$('#encodeWaterModal').modal('show')
			})
			$('#encodeWaterModal').on('hidden.bs.modal', function(){
				$('#encodeWaterModalBody').empty()
			})
			$('#encodeWaterSave').on('click', function(e){
				e.preventDefault()
				const inputs = $('.input-cubic')
				let totalInputted = 0;
				let bills = []
				for(let c=0; c<inputs.length; c++){
					totalInputted = eval(totalInputted+'+'+inputs.eq(c).val())
				}
				if(totalInputted == $(this).attr('usage')){
					const pricePerKwH = eval(`${$(this).attr('amountDue')}/${$(this).attr('usage')}`)
					for(let d=0; d<inputs.length; d++){
						let usageNow = eval(`${inputs.eq(d).val()}-${inputs.eq(d).attr('previousReading')}`)
						bills.push({
							contractId: inputs.eq(d).attr('contractId'),
							currentMeterReading: inputs.eq(d).val(),
							totalUsage: usageNow,
							amountDue: eval(`${pricePerKwH}*${usageNow}`),
							dueDate: $(this).attr('dueDate'),
							mainBillId: $(this).attr('billId')
						})
						if(d == inputs.length-1){
							$.post('/admin/encode-water-bill', {lesseeBills: bills})
							.done(function(){
								location.href='/admin/water-consumption'
							})
						}
					}
				}
				else{
					swal({
						title: `Inputs do not tally`,
						text: `The needed total cubic meter usage to be inputted must be ${$(this).attr('usage')}`,
						type: 'error'
					})
				}
			})
		})